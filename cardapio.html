<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardÃ¡pio - Melo Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8f5f2; }
        
        /* Estilo Conserta CELL Original */
        .header-melo { background-color: #e65100; position: relative; }
        .logo-box { width: 85px; height: 85px; background: white; border-radius: 12px; position: absolute; top: 15px; left: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 5px; }
        .store-info-bar { background-color: rgba(0,0,0,0.05); padding: 10px 20px; font-size: 11px; font-weight: bold; color: white; display: flex; gap: 15px; }
        
        .btn-aberto { background-color: #ffffff; color: #2e7d32; padding: 4px 12px; border-radius: 50px; font-size: 10px; font-weight: 900; text-transform: uppercase; }
        
        /* Cards de Produto Estilo Original */
        .card-produto { background: white; border-radius: 35px; border: 1px solid #f0f0f0; padding: 20px; display: flex; align-items: center; gap: 15px; transition: all 0.2s; position: relative; }
        .img-produto { width: 80px; height: 80px; border-radius: 15px; object-cover: cover; background: #f9f9f9; }
        
        .btn-add { background-color: #f57c00; color: white; width: 35px; height: 35px; border-radius: 12px; font-size: 20px; font-weight: bold; display: flex; items-center; justify-center; position: absolute; right: 20px; bottom: 20px; box-shadow: 0 4px 10px rgba(245, 124, 0, 0.3); }

        /* Sacola Slide Up */
        .sacola-painel { border-radius: 40px 40px 0 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .sacola-show { transform: translateY(0); }
        
        .input-melo { background: #f9f9f9; border-radius: 18px; padding: 15px; border: 1px solid #eee; font-weight: bold; outline: none; }
    </style>
</head>
<body class="pb-32">

    <header class="header-melo pt-24 pb-6">
        <div class="logo-box">
            <img id="view-logo" src="https://via.placeholder.com/100" class="w-full h-full object-contain rounded-lg">
        </div>
        <div class="px-6 mt-4">
            <h1 id="view-store-name" class="text-white text-2xl font-black italic uppercase tracking-tighter">Carregando...</h1>
            <div class="flex items-center justify-between mt-2">
                <div class="text-white/80 text-[10px] font-bold uppercase tracking-widest flex gap-3">
                    <span id="view-horario">ðŸ•’ --:-- as --:--</span>
                    <span id="view-entrega">ðŸ›µ Entrega rÃ¡pida</span>
                </div>
                <span class="btn-aberto" id="view-status">Aberto</span>
            </div>
        </div>
    </header>

    <nav class="flex gap-4 px-6 py-6 overflow-x-auto no-scrollbar bg-white shadow-sm sticky top-0 z-30">
        <div id="category-list" class="flex gap-2">
            </div>
    </nav>

    <main class="max-w-3xl mx-auto px-6 mt-6 space-y-12" id="cardapio-container">
        </main>

    <div id="bar-sacola" class="fixed bottom-6 left-0 right-0 px-6 z-40 hidden">
        <button onclick="toggleSacola()" class="w-full bg-[#1a1a1a] text-white p-5 rounded-[25px] flex justify-between items-center shadow-2xl active:scale-95 transition-transform">
            <div class="flex items-center gap-3">
                <span class="bg-[#f57c00] text-white w-6 h-6 flex items-center justify-center rounded-full text-[10px] font-black" id="cart-count">0</span>
                <span class="uppercase font-black italic text-xs tracking-widest">Ver Minha Sacola</span>
            </div>
            <span class="font-black italic text-sm" id="cart-total-bar">R$ 0,00</span>
        </button>
    </div>

    <div id="modal-sacola" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end">
        <div class="bg-white w-full max-w-2xl mx-auto sacola-painel p-8 overflow-y-auto" style="height: 85vh;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic uppercase tracking-tighter">Sua Sacola</h2>
                <button onclick="toggleSacola()" class="text-gray-300 text-3xl font-bold">&times;</button>
            </div>

            <div id="cart-items-list" class="space-y-4 mb-8">
                </div>

            <div class="space-y-4 border-t pt-6">
                <h3 class="text-xs font-black uppercase tracking-widest text-gray-400 italic">InformaÃ§Ãµes de Entrega</h3>
                <input type="text" id="order-nome" placeholder="Seu Nome" class="w-full input-melo text-sm">
                <input type="text" id="order-end" placeholder="Seu EndereÃ§o Completo" class="w-full input-melo text-sm">
                
                <div class="flex justify-between items-center py-4">
                    <span class="font-black text-gray-400 text-[10px] uppercase italic">Valor Total:</span>
                    <span class="text-2xl font-black italic text-[#f57c00]" id="cart-total-final">R$ 0,00</span>
                </div>

                <button onclick="enviarWhatsApp()" class="w-full bg-[#f57c00] text-white py-5 rounded-[20px] font-black italic uppercase text-sm shadow-lg shadow-orange-200 active:scale-95 transition-all">
                    Finalizar Pedido via WhatsApp ðŸš€
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xhfwrbjxitcrktccdrpn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoZndyYmp4aXRjcmt0Y2NkcnBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjQ5NTksImV4cCI6MjA4NjIwMDk1OX0.nyGJxdNT-qiH-oqJL4KDKA-7bRtlj5UxmXy32RswPUc';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const params = new URLSearchParams(window.location.search);
        const slug = params.get('loja');
        let carrinho = [];
        let numZap = "";

        async function carregar() {
            const { data: profile } = await sb.from('profiles').select('*').eq('slug', slug).single();
            if(!profile) return;
            numZap = profile.whatsapp_number;
            document.getElementById('view-store-name').innerText = profile.store_name;

            const { data: info } = await sb.from('store_info').select('*').eq('name', profile.store_name).single();
            if(info) {
                document.getElementById('view-logo').src = info.logo_url;
                document.getElementById('view-horario').innerText = `ðŸ•’ ${info.opening_time} as ${info.closing_time}`;
            }

            const { data: produtos } = await sb.from('products').select('*').eq('tenant_id', profile.id).eq('is_active', true);
            renderizar(produtos);
        }

        function renderizar(produtos) {
            const container = document.getElementById('cardapio-container');
            const cats = [...new Set(produtos.map(p => p.categoria_produtos || 'Geral'))];
            
            container.innerHTML = "";
            cats.forEach(cat => {
                let html = `<div><h2 class="text-sm font-black italic uppercase text-gray-400 mb-4 border-l-4 border-[#f57c00] pl-3">${cat}</h2><div class="space-y-4">`;
                produtos.filter(p => p.categoria_produtos === cat).forEach(p => {
                    html += `
                        <div class="card-produto shadow-sm">
                            <img src="${p.image_url || 'https://via.placeholder.com/150'}" class="img-produto">
                            <div class="flex-1 pr-10">
                                <h4 class="font-black italic uppercase text-[12px] leading-tight">${p.name}</h4>
                                <p class="text-[10px] text-gray-400 font-bold mt-1 line-clamp-2">${p.description || ''}</p>
                                <p class="text-[#f57c00] font-black italic mt-2 text-base font-sans">R$ ${p.price.toFixed(2)}</p>
                            </div>
                            <button onclick="add('${p.name}', ${p.price})" class="btn-add">+</button>
                        </div>`;
                });
                html += "</div></div>";
                container.innerHTML += html;
            });
        }

        function add(nome, preco) {
            const item = carrinho.find(i => i.nome === nome);
            if(item) item.qtd++; else carrinho.push({nome, preco, qtd: 1});
            atualizar();
        }

        function remove(nome) {
            const idx = carrinho.findIndex(i => i.nome === nome);
            if(idx > -1) {
                carrinho[idx].qtd--;
                if(carrinho[idx].qtd === 0) carrinho.splice(idx, 1);
            }
            atualizar();
        }

        function atualizar() {
            const total = carrinho.reduce((acc, i) => acc + (i.preco * i.qtd), 0);
            const qtd = carrinho.reduce((acc, i) => acc + i.qtd, 0);

            document.getElementById('cart-count').innerText = qtd;
            document.getElementById('cart-total-bar').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('cart-total-final').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('bar-sacola').classList.toggle('hidden', carrinho.length === 0);

            document.getElementById('cart-items-list').innerHTML = carrinho.map(i => `
                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-[20px]">
                    <div>
                        <p class="font-black italic uppercase text-[11px]">${i.nome}</p>
                        <p class="text-[#f57c00] font-black text-xs">R$ ${(i.preco * i.qtd).toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="remove('${i.nome}')" class="w-8 h-8 bg-white border rounded-lg font-black">-</button>
                        <span class="font-black italic text-xs">${i.qtd}</span>
                        <button onclick="add('${i.nome}', ${i.preco})" class="w-8 h-8 bg-white border rounded-lg font-black text-[#f57c00]">+</button>
                    </div>
                </div>`).join('');
        }

        function toggleSacola() {
            const modal = document.getElementById('modal-sacola');
            const painel = modal.querySelector('.sacola-painel');
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => painel.classList.add('sacola-show'), 10);
            } else {
                painel.classList.remove('sacola-show');
                setTimeout(() => modal.classList.add('hidden'), 400);
            }
        }

        function enviarWhatsApp() {
            const nome = document.getElementById('order-nome').value;
            const end = document.getElementById('order-end').value;
            if(!nome || !end) return alert("Preencha seu nome e endereÃ§o!");

            let msg = `*NOVO PEDIDO - MELO DELIVERY*%0A%0A`;
            msg += `*Cliente:* ${nome}%0A*EndereÃ§o:* ${end}%0A%0A*ITENS:*%0A`;
            carrinho.forEach(i => msg += `${i.qtd}x ${i.nome} - R$ ${(i.preco * i.qtd).toFixed(2)}%0A`);
            msg += `%0A*TOTAL: ${document.getElementById('cart-total-final').innerText}*`;
            window.open(`https://wa.me/${numZap}?text=${msg}`, '_blank');
        }

        carregar();
    </script>
</body>
</html>
