<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Parceiro - Melo Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        .aba-ativa { color: #f97316; border-bottom: 4px solid #f97316; }
        .aba-inativa { color: #9ca3af; }
        .card-hover:hover { border-color: #fb923c; transform: translateY(-2px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="bg-[#fcfcfc] min-h-screen pb-20 font-sans text-gray-800">

    <header class="bg-gradient-to-r from-orange-500 to-orange-600 shadow-lg pb-20 pt-8 px-6 rounded-b-[3rem] relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
        
        <nav class="max-w-5xl mx-auto flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-2xl backdrop-blur-md border border-white/30">
                    <span class="text-2xl">‚öôÔ∏è</span>
                </div>
                <div>
                    <h1 class="text-white font-black italic text-xl leading-none uppercase tracking-tighter">Melo Delivery</h1>
                    <p class="text-orange-100 text-[10px] font-bold uppercase tracking-widest mt-1 opacity-80" id="nome-loja-nav">Carregando painel...</p>
                </div>
            </div>
            <button onclick="logout()" class="bg-white/10 hover:bg-red-500 text-white px-5 py-2 rounded-full text-xs font-black transition-all border border-white/20 active:scale-95">SAIR</button>
        </nav>
    </header>

    <div class="max-w-4xl mx-auto -mt-10 px-6 relative z-20">
        <div class="bg-white rounded-[2rem] shadow-xl p-2 flex gap-2">
            <button onclick="mudarAba('produtos')" id="tab-produtos" class="flex-1 py-4 font-black italic uppercase text-xs tracking-wider rounded-[1.5rem] transition-all aba-ativa">üì¶ Meus Itens</button>
            <button onclick="mudarAba('loja')" id="tab-loja" class="flex-1 py-4 font-black italic uppercase text-xs tracking-wider rounded-[1.5rem] transition-all aba-inativa">üè™ Minha Loja</button>
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-6 mt-4">

        <div id="conteudo-produtos" class="space-y-8 animate-fade">
            
            <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div class="space-y-1 text-center md:text-left">
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Hor√°rio de Hoje</p>
                    <div class="flex items-center justify-center md:justify-start gap-2">
                        <input type="time" id="inp-abre" class="bg-gray-50 font-bold p-2 rounded-lg text-sm border-none outline-none focus:ring-2 focus:ring-orange-100">
                        <span class="text-gray-300">√†s</span>
                        <input type="time" id="inp-fecha" class="bg-gray-50 font-bold p-2 rounded-lg text-sm border-none outline-none focus:ring-2 focus:ring-orange-100">
                    </div>
                </div>
                <div class="text-center">
                   <button onclick="salvarHorario()" class="bg-gray-900 text-white text-[10px] font-black px-6 py-3 rounded-xl hover:bg-orange-500 transition-all active:scale-95">ATUALIZAR STATUS</button>
                </div>
                <div class="text-center md:text-right">
                    <button onclick="abrirModalCriacao()" class="w-full md:w-auto bg-orange-500 text-white px-8 py-4 rounded-2xl font-black italic uppercase text-xs shadow-lg shadow-orange-200 hover:bg-orange-600 transition-all active:scale-95">
                        + Novo Produto
                    </button>
                </div>
            </section>

            <div id="lista-produtos" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full py-20 text-center text-gray-300 font-black italic uppercase tracking-widest">Sincronizando card√°pio...</div>
            </div>
        </div>

        <div id="conteudo-loja" class="hidden space-y-8 animate-fade">
            <section class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100">
                <h2 class="text-xl font-black italic text-gray-800 mb-8 uppercase tracking-tighter flex items-center gap-2">
                    <span class="w-2 h-6 bg-orange-500 rounded-full"></span> Identidade Visual
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="space-y-4">
                        <p class="text-xs font-black text-gray-400 uppercase tracking-widest text-center">Logo Marca</p>
                        <div class="w-32 h-32 mx-auto bg-gray-50 rounded-full border-2 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden group">
                            <input type="file" id="up-logo" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewLoja(this, 'view-logo')">
                            <img id="view-logo" src="" class="w-full h-full object-cover">
                            <span class="absolute text-[10px] font-black text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity">TROCAR</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <p class="text-xs font-black text-gray-400 uppercase tracking-widest text-center">Banner da Vitrine</p>
                        <div class="w-full h-32 bg-gray-50 rounded-[2rem] border-2 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden group">
                            <input type="file" id="up-banner" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewLoja(this, 'view-banner')">
                            <img id="view-banner" src="" class="w-full h-full object-cover">
                            <span class="absolute text-[10px] font-black text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity">TROCAR CAPA</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100">
                <h2 class="text-xl font-black italic text-gray-800 mb-6 uppercase tracking-tighter flex items-center gap-2">
                    <span class="w-2 h-6 bg-orange-500 rounded-full"></span> Valores de Entrega
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-2">Taxa Bairros Pr√≥ximos</label>
                        <input type="number" id="fee-main" step="0.50" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-orange-100 font-bold text-gray-700">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-2">Taxa Bairros Distantes</label>
                        <input type="number" id="fee-far" step="0.50" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-orange-100 font-bold text-gray-700">
                    </div>
                </div>
                <button onclick="salvarConfigLoja()" id="btn-salvar-loja" class="w-full mt-8 py-5 bg-gray-900 text-white font-black italic uppercase text-xs tracking-widest rounded-2xl hover:bg-orange-500 transition-all active:scale-95 shadow-lg">
                    Salvar Altera√ß√µes
                </button>
            </section>
        </div>

    </main>

    <div id="modal-produto" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[3rem] p-8 shadow-2xl relative animate-fade">
            <button onclick="fecharModalProduto()" class="absolute top-6 right-8 text-gray-300 hover:text-orange-500 font-black text-2xl transition-colors">&times;</button>
            
            <h3 id="titulo-modal" class="text-2xl font-black italic text-gray-800 mb-8 uppercase tracking-tighter">Novo Produto</h3>
            
            <form onsubmit="salvarProduto(event)" class="space-y-5">
                <input type="hidden" id="prod-id-edit">
                
                <div class="w-full h-40 bg-gray-50 border-2 border-dashed border-gray-200 rounded-[2rem] flex flex-col items-center justify-center relative group overflow-hidden">
                    <input type="file" id="prod-img" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImagem(this)">
                    <img id="img-preview" class="hidden w-full h-full object-contain p-2">
                    <div id="upload-placeholder" class="text-center group-hover:scale-110 transition-transform">
                        <span class="text-4xl">üì∏</span>
                        <p class="text-[10px] font-black text-gray-400 uppercase mt-2">Toque para adicionar foto</p>
                    </div>
                </div>

                <div class="space-y-2">
                    <input type="text" id="prod-nome" placeholder="Nome do Produto" required class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-100 font-bold text-gray-800">
                </div>
                
                <div class="flex gap-4">
                    <input type="number" id="prod-preco" step="0.01" placeholder="R$ Pre√ßo" required class="w-1/2 p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-100 font-bold text-gray-800">
                    <select id="prod-cat" required class="w-1/2 p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-100 font-bold text-gray-500">
                        <option value="">Categoria</option>
                        <option value="Pizzas">Pizzas</option>
                        <option value="Lanches">Lanches</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Sobremesas">Sobremesas</option>
                    </select>
                </div>

                <textarea id="prod-desc" rows="3" placeholder="Descri√ß√£o do produto..." class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-orange-100 font-bold text-gray-800 resize-none"></textarea>

                <button type="submit" id="btn-criar" class="w-full py-5 bg-orange-500 text-white font-black italic uppercase text-xs tracking-widest rounded-2xl shadow-lg shadow-orange-100 hover:bg-orange-600 transition-all active:scale-95">
                    SALVAR NO CARD√ÅPIO
                </button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xhfwrbjxitcrktccdrpn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoZndyYmp4aXRjcmt0Y2NkcnBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjQ5NTksImV4cCI6MjA4NjIwMDk1OX0.nyGJxdNT-qiH-oqJL4KDKA-7bRtlj5UxmXy32RswPUc';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let user = null;
        let storeInfoId = null;
        let produtosCache = [];

        async function checkAuth() {
            const { data: { session } } = await sbClient.auth.getSession();
            if (!session) return window.location.href = 'login.html';
            user = session.user;
            carregarDadosLoja();
        }

        async function carregarDadosLoja() {
            const { data: profile } = await sbClient.from('profiles').select('*').eq('id', user.id).single();
            if (!profile) return alert("Erro: Loja n√£o encontrada.");
            document.getElementById('nome-loja-nav').innerText = profile.store_name;

            const { data: info } = await sbClient.from('store_info').select('*').eq('name', profile.store_name).single();
            if (info) {
                storeInfoId = info.id;
                document.getElementById('inp-abre').value = info.opening_time || "18:00";
                document.getElementById('inp-fecha').value = info.closing_time || "23:59";
                document.getElementById('fee-main').value = info.delivery_fee_main || 5.00;
                document.getElementById('fee-far').value = info.delivery_fee_far || 10.00;
                if (info.logo_url) document.getElementById('view-logo').src = info.logo_url;
                if (info.banner_url) document.getElementById('view-banner').src = info.banner_url;
            }
            carregarProdutos();
        }

        function mudarAba(aba) {
            const tabProd = document.getElementById('tab-produtos');
            const tabLoja = document.getElementById('tab-loja');
            const divProd = document.getElementById('conteudo-produtos');
            const divLoja = document.getElementById('conteudo-loja');

            if (aba === 'produtos') {
                tabProd.className = "flex-1 py-4 font-black italic uppercase text-xs tracking-wider rounded-[1.5rem] transition-all aba-ativa";
                tabLoja.className = "flex-1 py-4 font-black italic uppercase text-xs tracking-wider rounded-[1.5rem] transition-all aba-inativa";
                divProd.classList.remove('hidden'); divLoja.classList.add('hidden');
            } else {
                tabProd.className = "flex-1 py-4 font-black italic uppercase text-xs tracking-wider rounded-[1.5rem] transition-all aba-inativa";
                tabLoja.className = "flex-1 py-4 font-black italic uppercase text-xs tracking-wider rounded-[1.5rem] transition-all aba-ativa";
                divProd.classList.add('hidden'); divLoja.classList.remove('hidden');
            }
        }

        async function carregarProdutos() {
            const { data: produtos } = await sbClient.from('products').select('*').eq('tenant_id', user.id).order('name', { ascending: true });
            produtosCache = produtos || [];
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            
            if (produtos.length === 0) {
                lista.innerHTML = '<div class="col-span-full py-10 text-center text-gray-300 font-bold italic uppercase">Seu card√°pio est√° vazio</div>';
                return;
            }

            produtos.forEach(p => {
                lista.innerHTML += `
                    <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-4 card-hover transition-all group">
                        <img src="${p.image_url}" class="w-20 h-20 rounded-2xl object-cover bg-gray-50 border border-gray-50 shrink-0">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 truncate uppercase text-xs tracking-tight">${p.name}</h3>
                            <p class="text-green-600 font-black text-sm mt-1 italic">R$ ${p.price.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="abrirModalEdicao('${p.id}')" class="w-10 h-10 rounded-xl bg-orange-50 text-orange-500 hover:bg-orange-500 hover:text-white transition-all flex items-center justify-center">‚úèÔ∏è</button>
                            <button onclick="deletarProduto('${p.id}')" class="w-10 h-10 rounded-xl bg-gray-50 text-gray-400 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
        }

        // Fun√ß√µes de Modal e CRUD (Mantidas as mesmas do c√≥digo anterior)
        function abrirModalCriacao() { 
            document.querySelector('form').reset(); 
            document.getElementById('prod-id-edit').value = ""; 
            document.getElementById('img-preview').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('modal-produto').classList.remove('hidden'); 
        }

        function abrirModalEdicao(id) {
            const p = produtosCache.find(x => x.id === id);
            if(!p) return;
            document.getElementById('prod-id-edit').value = p.id;
            document.getElementById('prod-nome').value = p.name;
            document.getElementById('prod-preco').value = p.price;
            document.getElementById('prod-cat').value = p.categoria_produtos;
            document.getElementById('prod-desc').value = p.description || "";
            document.getElementById('img-preview').src = p.image_url;
            document.getElementById('img-preview').classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');
            document.getElementById('modal-produto').classList.remove('hidden');
        }

        function fecharModalProduto() { document.getElementById('modal-produto').classList.add('hidden'); }

        async function salvarProduto(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-criar');
            btn.innerText = "Salvando..."; btn.disabled = true;
            try {
                const id = document.getElementById('prod-id-edit').value;
                const file = document.getElementById('prod-img').files[0];
                let url = null;

                if (file) {
                    const nome = `prod_${Date.now()}`;
                    await sbClient.storage.from('product-images').upload(`${user.id}/${nome}`, file);
                    const { data } = sbClient.storage.from('product-images').getPublicUrl(`${user.id}/${nome}`);
                    url = data.publicUrl;
                }

                const dados = {
                    name: document.getElementById('prod-nome').value,
                    price: parseFloat(document.getElementById('prod-preco').value),
                    categoria_produtos: document.getElementById('prod-cat').value,
                    description: document.getElementById('prod-desc').value,
                    is_available: true
                };

                if (url) dados.image_url = url;
                else if (!id) dados.image_url = 'https://via.placeholder.com/150';

                if (id) await sbClient.from('products').update(dados).eq('id', id);
                else { dados.tenant_id = user.id; await sbClient.from('products').insert(dados); }

                fecharModalProduto(); carregarProdutos();
            } catch (e) { alert("Erro: " + e.message); }
            finally { btn.innerText = "SALVAR NO CARD√ÅPIO"; btn.disabled = false; }
        }

        async function deletarProduto(id) { if(confirm("Excluir item?")) { await sbClient.from('products').delete().eq('id', id); carregarProdutos(); } }
        async function salvarHorario() { const btn = document.getElementById('btn-salvar-hora'); btn.innerText = "..."; await sbClient.from('store_info').update({ opening_time: document.getElementById('inp-abre').value, closing_time: document.getElementById('inp-fecha').value }).eq('id', storeInfoId); alert("Status atualizado!"); btn.innerText = "ATUALIZAR STATUS"; }
        async function logout() { await sbClient.auth.signOut(); window.location.href = 'login.html'; }
        function previewImagem(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = function(e) { document.getElementById('img-preview').src = e.target.result; document.getElementById('img-preview').classList.remove('hidden'); document.getElementById('upload-placeholder').classList.add('hidden'); }; r.readAsDataURL(input.files[0]); } }
        function previewLoja(input, id) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = function(e) { document.getElementById(id).src = e.target.result; }; r.readAsDataURL(input.files[0]); } }

        checkAuth();
    </script>
</body>
</html>
